<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIS PEAK | Valerio Callaringi</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shpjs/4.0.4/shp.min.js"></script>
    <script src="https://unpkg.com/@ngageoint/geopackage@4.2.3/dist/geopackage.min.js"></script>
    
    <style>
        :root {
            --neon: #00ff9d;
            --bg: #0a0c10;
            --panel: #111418;
            --text: #e0e0e0;
            --border: rgba(255, 255, 255, 0.1);
        }

        body { background-color: var(--bg); color: var(--text); font-family: 'Exo 2', sans-serif; margin: 0; }

        .header {
            padding: 20px;
            background: linear-gradient(to bottom, #111, var(--bg));
            text-align: center;
            border-bottom: 1px solid var(--neon);
        }

        .dashboard { max-width: 1200px; margin: 20px auto; background: var(--panel); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        
        .controls {
            padding: 15px;
            background: #161b22;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            border-bottom: 1px solid var(--border);
        }

        #map { height: 600px; width: 100%; background: #000; }

        .btn-neon {
            background: transparent; border: 1px solid var(--neon); color: var(--neon);
            padding: 8px 15px; cursor: pointer; font-weight: bold; text-transform: uppercase; border-radius: 4px;
        }
        .btn-neon:hover { background: var(--neon); color: #000; }

        .mission-section { padding: 30px; border-top: 1px solid var(--border); background: #0d1116; }

        input[type="file"] { color: #8b949e; font-size: 0.8rem; }
        
        .leaflet-popup-content b { color: var(--neon); }
        .popup-btn { background: #333; color: white; border: none; padding: 5px; margin: 2px; cursor: pointer; width: 100%; border-radius: 3px; }
    </style>
</head>
<body>

    <div class="header">
        <h1 style="letter-spacing: 5px; margin: 0;">GIS PEAK</h1>
        <p>Laboratorio Geologico di Valerio Callaringi</p>
    </div>

    <div class="dashboard">
        <div class="controls">
            <div style="display: flex; flex-direction: column;">
                <label style="font-size: 0.7rem; color: var(--neon);">CARICA FILE (.GPKG, .ZIP, .JSON)</label>
                <input type="file" id="fileInput">
            </div>
            <div style="display: flex; flex-direction: column;">
                <label style="font-size: 0.7rem; color: var(--neon);">COLORE LAYER</label>
                <input type="color" id="colorPicker" value="#00ff9d" style="height: 35px; border: none; background: none; cursor: pointer;">
            </div>
            <button onclick="saveToCloud()" class="btn-neon" style="margin-top: 15px;">üíæ PUBBLICA SUL DATABASE</button>
        </div>

        <div id="map"></div>

        <div class="mission-section">
            <h3 style="color: var(--neon); margin-top: 0;">MISSIONE DEL PROGETTO</h3>
            <p>Questo portale √® dedicato alla visualizzazione e archiviazione di dati geospaziali relativi alla tettonica e alla geologia regionale.</p>
            <p style="border-left: 3px solid var(--neon); padding-left: 15px; font-style: italic;">
                "La missione di questo progetto √® esclusivamente a scopo di <strong>divulgazione scientifica</strong> e assolutamente <strong>non a scopo di lucro</strong>."
            </p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- CONFIGURAZIONE DATABASE (INSERITA) ---
        const SB_URL = "https://nygybfkstkevlfkmaqxa.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55Z3liZmtzdGtldmxma21hcXhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzUyMzA3MDMsImV4cCI6MjA1MDgwNjcwM30.q77k26I5Y0B77O7fR977O7fR977O7fR977O7fR977O7fR977O7fR9";
        const _supabase = supabase.createClient(SB_URL, SB_KEY);
        const ADMIN_PASS = "Valerio_1991";

        lucide.createIcons();

        // Inizializza Mappa
        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
        const map = L.map('map', { center: [41.83, 13.33], zoom: 12, layers: [satellite] });
        const layerControl = L.control.layers({ "Satellite": satellite }, {}, { collapsed: false }).addTo(map);

        let tempLayer = null;
        let tempData = null;
        let tempName = "";

        // 1. CARICA LAYER DAL CLOUD
        async function loadLayers() {
            const { data, error } = await _supabase.from('layers').select('*');
            if (data) {
                data.forEach(item => {
                    const l = L.geoJSON(item.data, {
                        style: { color: item.color || '#00ff9d', weight: 2, fillOpacity: 0.3 },
                        onEachFeature: (f, layer) => {
                            layer.bindPopup(`
                                <b>Layer: ${item.name}</b><br>
                                <button class="popup-btn" onclick="map.fitBounds(this.options.layer.getBounds())">üîç ZOOM QUI</button>
                                <button class="popup-btn" style="background:#800;" onclick="deleteLayer('${item.id}')">üóëÔ∏è ELIMINA</button>
                            `);
                            layer.getPopup().options.layer = layer;
                        }
                    }).addTo(map);
                    layerControl.addOverlay(l, "üåç " + item.name);
                });
            }
        }
        loadLayers();

        // 2. GESTIONE IMPORTAZIONE FILE
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            tempName = file.name;
            const color = document.getElementById('colorPicker').value;

            if (file.name.endsWith('.gpkg')) {
                const buffer = await file.arrayBuffer();
                const gp = await window.geopackage.GeoPackageConnection.connectWithUint8Array(new Uint8Array(buffer));
                const tables = await gp.getFeatureTables();
                tempData = await gp.getFeaturesFromFeatureTable(tables[0]);
            } else if (file.name.endsWith('.zip')) {
                tempData = await shp(await file.arrayBuffer());
            } else {
                tempData = JSON.parse(await file.text());
            }

            if (tempLayer) map.removeLayer(tempLayer);
            tempLayer = L.geoJSON(tempData, { style: { color: color, weight: 3 } }).addTo(map);
            map.fitBounds(tempLayer.getBounds());
            alert("Anteprima caricata! Seleziona 'Pubblica' per salvare nel cloud.");
        });

        // 3. SALVATAGGIO SU SUPABASE
        async function saveToCloud() {
            if (!tempData) return alert("Carica prima un file!");
            if (prompt("Inserisci Password Amministratore:") !== ADMIN_PASS) return alert("Accesso negato!");

            const color = document.getElementById('colorPicker').value;
            const { error } = await _supabase.from('layers').insert([{ 
                name: tempName, 
                data: tempData, 
                color: color 
            }]);

            if (error) {
                alert("Errore nel salvataggio: " + error.message);
            } else {
                alert("Layer pubblicato con successo!");
                location.reload();
            }
        }

        // 4. ELIMINAZIONE LAYER
        async function deleteLayer(id) {
            if (prompt("Password per eliminare:") !== ADMIN_PASS) return alert("Azione annullata.");
            const { error } = await _supabase.from('layers').delete().eq('id', id);
            if (!error) location.reload();
        }
    </script>
</body>
</html>
